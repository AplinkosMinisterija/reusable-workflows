name: Composer update

on:
  workflow_call:
    inputs:
      runs-on:
        description: "Optional input to set an operating systems which the workflow uses. Defaults to ubuntu-latest if not set"
        required: false
        type: string
        default: "ubuntu-latest"
      timeout-minutes:
        description: "Optional input to set timeout minutes. Defaults to 15"
        required: false
        type: number
        default: 15
      node-version:
        description: "Optional input to set node version"
        required: false
        type: string
        default: "20.x"
      composer-version:
        description: "Optional input to set composer version. Defaults to 2.6"
        type: string
        required: false
        default: "2.6"
      branch-prefix:
        description: "Optional input to set branch prefix. Defaults to composer-update"
        type: string
        required: false
        default: composer-update
      pr-reviewers:
        description: "Optional input to set PR reviewers"
        type: string
        required: false
        default: ""
      pr-labels:
        description: "Optional input to set PR labels"
        type: string
        required: false
        default: ""
      pr-base-branch:
        description: "Optional input to set PR's base branch. Defaults to main"
        type: string
        required: false
        default: "main"
      debug:
        description: "Enable verbose logging for troubleshooting"
        type: boolean
        required: false
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  composer-update:
    name: Composer update
    runs-on: ${{inputs.runs-on}}
    timeout-minutes: ${{inputs.timeout-minutes}}
    env:
      update_needed: 'false'
      BRANCH_NAME: ''
      has_changes: 'false'
      DEBUG: ${{ inputs.debug }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js ${{inputs.node-version}}
        uses: actions/setup-node@v4
        with:
          node-version: ${{inputs.node-version}}

      - name: Install Yarn
        run: npm install -g yarn

      - name: Install Dependencies
        run: yarn install --frozen-lockfile

      - name: Pre-pull Composer Image (Cache Optimization)
        run: docker pull composer:${{ inputs.composer-version }}

      - name: Check for Composer updates (via Docker)
        id: check-updates
        run: |
          echo "ðŸ” Running composer outdated..."
          UPDATE_NEEDED="$(docker run --rm -v "$PWD:/app" -w /app composer:${{ inputs.composer-version }} sh -c '
            set -e
            git config --global --add safe.directory /app
            composer install --no-progress --prefer-dist --no-interaction
            set +e
            if [ "${DEBUG:-false}" = "true" ]; then
              echo "--- composer outdated (debug) ---"
              composer outdated --strict --no-interaction --no-ansi
              echo "--- end ---"
            else
              composer outdated --strict --no-interaction --no-ansi >/dev/null 2>&1
            fi
            code=$?
            set -e
            if [ "$code" -eq 0 ]; then
              echo false
            elif [ "$code" -eq 1 ]; then
              echo true
            else
              exit "$code"
            fi
          ')"
          echo "update_needed=$UPDATE_NEEDED" >> "$GITHUB_ENV"
          echo "ðŸ”„ Update needed: $UPDATE_NEEDED"

      - name: Set Update Branch Name
        run: |
          BRANCH_NAME="${{inputs.branch-prefix}}-$(date +'%Y%m%d')"
          echo "BRANCH_NAME=$BRANCH_NAME" >> "$GITHUB_ENV"
          echo "ðŸŒ¿ Branch name: $BRANCH_NAME"

      - name: Update Composer (via Docker)
        if: env.update_needed == 'true'
        run: |
          echo "ðŸš€ Running composer update..."
          docker run --rm -v "$PWD:/app" -w /app composer:${{ inputs.composer-version }} sh -c "
            git config --global --add safe.directory /app &&
            composer update --no-progress --prefer-dist --no-interaction
          "

      - name: Check for Changes
        if: env.update_needed == 'true'
        run: |
          CHANGES="$(git status --porcelain composer.json composer.lock)"
          if [ -n "$CHANGES" ]; then
            echo "has_changes=true" >> "$GITHUB_ENV"
            echo "âœ… Changes detected in composer files."
          else
            echo "has_changes=false" >> "$GITHUB_ENV"
            echo "âœ… No changes detected."
          fi

      - name: Create Pull Request
        if: env.update_needed == 'true' && env.has_changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          branch: ${{ env.BRANCH_NAME }}
          base: ${{inputs.pr-base-branch}}
          add-paths: |
            composer.json
            composer.lock
          commit-message: "Auto update composer (${{ env.BRANCH_NAME }})"
          title: "Composer auto update"
          body: "This PR updates composer packages to the latest version."
          labels: ${{inputs.pr-labels}}
          reviewers: ${{inputs.pr-reviewers}}
          token: ${{ secrets.GITHUB_TOKEN }}
